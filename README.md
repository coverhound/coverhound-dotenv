# CoverHound Dotenv

[![Build Status](https://api.travis-ci.org/coverhound/coverhound-dotenv.svg?branch=master)](https://travis-ci.org/coverhound/coverhound-dotenv)

This gem is a dotenv implementation for CoverHound. It has these variances of
behavior based on environment:

### Testing

Uses `config/environments/test.env` to load in environment variables. This file
is not encrypted.

### Development

Uses `config/environments/development.env.enc` to load in environment variables.
This file is encrypted with `config/environments/dotenv.key`, which _should be
gitignored_ and shared with other developers.

This is considered the source of truth in terms of what environment variables
can / should be defined.

### Staging/Preprod/Production

We use [`chamber`](https://github.com/segmentio/chamber) to talk to AWS and
download our secured variables from the ParameterStore. More on this in the
ParameterStore configuration section.

These variables are injected into Rails' environment.

## Prerequisites

Note: For the sake of consistency, we assume that the server and client are
using the same `chamber` version, and are on `> 1.17`.

### Server

Your server must have `chamber` installed in its path. It must also either:
1. Have AWS credentials set in the environment
2. Have an AWS role assigned to it which can decrypt the ParameterStore

### Client

In order to write values to the ParameterStore, you need `chamber` installed. On
OSX:

```sh
brew install chamber
```

### AWS

This gem assumes that each app + environment will have its own namespace and key
in the ParameterStore. For example, if our application is called `cyber`, we
would expect the `staging` environment to use the `cyber-staging` namespace.

## Usage

You must configure the app_name for this gem to work.

```rb
# config/application.rb
Coverhound::Dotenv.configure do |config|
  config.app_name = "#{app_name}" # required
  config.region = "us-west-1"     # optional, defaults to us-west-1
end
```

You can also add a check in deployment that ensures the environment has been
set up:

```rb
# Capfile
require "capistrano/coverhound-dotenv"

# runs `rake ch:dotenv:validate_environment` after `bundler:install`
```

## AWS Configuration

Ensure the machine has has a role that can read the ParameterStore. There is an
existing policy called `ParameterStoreReadOnly` for this. Apply it to each
`$APPLICATION-$ENV` role.

Add one key per `$APPLICATION-$ENV` with the corresponding alias. Make sure that
it's in the same region that you intend to use (again, default: `us-west-1`)

[Example](https://console.aws.amazon.com/iam/home?region=us-west-1#/roles/cyber-staging)

Also ensure that engineers have access to the parameter store and the
corresponding keys per environment.

## Moving a codebase to ParameterStore

This gem ships with some rake tasks that should make it easier to convert
previous system using settings files into an environment variable based setup.

### Generate

```sh
bundle exec rake ch:dotenv:generate
```

This command generates your encrypted development dotenv file
(`config/environments/development.env.enc`) and corresponding key. Make sure to
add `config/environments/dotenv.key` to your `.gitignore` when you run this and
distribute the key!

You can edit the encrypted file with:

```sh
bundle exec rake ch:dotenv:edit
```

and view it with

```sh
bundle exec rake ch:dotenv:show
```

### Migrate

```sh
bundle exec rake ch:dotenv:migrate[ENV]
```

This command will take your existing `config/settings.yml` file and help you
create a dotenv file from it. It involves multiple steps:

1. It goes through the settings file and finds all (nested) keys and prompts you
   to map them to environment variables. It caches this file at
   `yaml-to.env.mapping`
2. Once you have saved your work, it prints out a `[ENV].env` file with
   corresponding key-value pairs and a `new.settings.yml` with
   `<%= ENV.fetch(KEY) %>` in place of the original values.

You are meant to run this once per environment, taking care to put whatever
`config/settings.yml` you are converting to `config/settings.yml`.

### Manual work, adjustment of generated files

Once you are satisfied with the output, you'll want to replace your
`config/settings.yml` with `new.settings.yml`. You will also manually need to
replace values (and add keys) for `config/database.yml`, `config/secrets.yml`,
`config/redis.yml` (I suggest moving these settings into Sidekiq's config) and
`config/sidekiq.yml`. See the [example](./example/config) for a suggested
implementation.

Once all of these files reference only ENV variables where there are secrets,
they are safe to put into version control. Do not, however, add any other files
generated by the migration to your version control, as these contain sensitive
information!

### Using the generated .env files

**Test**: `test.env` can simply be moved to `config/environments/test.env`

**Development**: Use `bundle exec rake ch:dotenv:edit` to copy paste your
contents into the encrypted file

**Staging, Preprod, Production**: There is another command that uploads the
contents of these .env files to our parameter store

```sh
# This command looks for $PWD/ENV.env
bundle exec rake ch:dotenv:upload[ENV]
```

You will want to use `bundle exec
rake ch:dotenv:edit` to copy the contents of the

```
brew install chamber
```

## Running Chamber manually

### Configuring AWS CLI

If you're running this on your local machine, you'll need to install AWS CLI.

```sh
brew install awscli
```

and then configure using your IAM settings:

```sh
aws configure

# AWS Access Key ID [None]: AKIAIOSFODNN7EXAMPLE
# AWS Secret Access Key [None]: wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY
# Default region name [None]: us-west-1
```

### Running the commands

You may want to manage credentials after the migration process. You'll have two
options: use the AWS interface or use chamber. I recommend the latter.

An example `APP_ENV` is `cyber-staging`. In order to run the commands below, the
following needs to be in your environment:

```sh
CHAMBER_KMS_KEY_ALIAS=[APP_ENV]
CHAMBER_AWS_REGION=us-west-1
```

List all current variables

```sh
chamber list [APP_ENV]
```

Add or replace a variable

```sh
chamber write [APP_ENV] [KEY] [VALUE]
```

Remove a variable

```sh
chamber remove [APP_ENV] [KEY]
```
